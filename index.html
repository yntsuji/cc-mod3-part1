<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Teachable Machine Audio Model</title>
</head>

<body>

    <div>Soita kitaran E- tai A-kieltä! E näkyy punaisena, A sinisenä.
    </div>
    <button type="button" onclick="init()">Start</button>

    <h2 id="result">Waiting...</h2>

    <div id="visual" style="
width:150px;
height:150px;
background:gray;
margin-top:20px;">
    </div>

    <div id="label-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

    <script type="text/javascript">

        const URL = "./tm-my-audio-model/";

        async function createModel() {
            const checkpointURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            const recognizer = speechCommands.create(
                "BROWSER_FFT",
                undefined,
                checkpointURL,
                metadataURL
            );

            await recognizer.ensureModelLoaded();
            return recognizer;
        }

        async function init() {

            const recognizer = await createModel();
            const classLabels = recognizer.wordLabels();

            const labelContainer = document.getElementById("label-container");
            labelContainer.innerHTML = "";

            for (let i = 0; i < classLabels.length; i++) {
                labelContainer.appendChild(document.createElement("div"));
            }

            recognizer.listen(result => {

                const scores = result.scores;

                for (let i = 0; i < classLabels.length; i++) {
                    const classPrediction =
                        classLabels[i] + ": " + scores[i].toFixed(2);
                    labelContainer.childNodes[i].innerHTML = classPrediction;
                }

                let highestIndex = 0;

                for (let i = 1; i < scores.length; i++) {
                    if (scores[i] > scores[highestIndex]) {
                        highestIndex = i;
                    }
                }

                let detectedSound = classLabels[highestIndex];
                let probability = scores[highestIndex];

                handleSound(detectedSound, probability);

            }, {
                includeSpectrogram: true,
                probabilityThreshold: 0.75,
                invokeCallbackOnNoiseAndUnknown: true,
                overlapFactor: 0.50
            });
        }

        function handleSound(sound, probability) {

            let result = document.getElementById("result");
            let visual = document.getElementById("visual");

            result.innerHTML = sound + " (" + probability.toFixed(2) + ")";

            if (sound === "E") {
                visual.style.backgroundColor = "red";
            }
            else if (sound === "A") {
                visual.style.backgroundColor = "blue";
            }
            else {
                visual.style.backgroundColor = "gray";
            }
        }

    </script>

</body>

</html>